#!/usr/bin/env node

/**
 * Obsidian Usage Stats Plugin - Build Package Script
 *
 * è¿™ä¸ªè„šæœ¬ä¼šå°†æ‰€æœ‰å¿…è¦çš„æ’ä»¶æ–‡ä»¶æ‰“åŒ…åˆ° /dist ç›®å½•ä¸­ï¼Œ
 * åŒ…æ‹¬ç¼–è¯‘åçš„ JavaScriptã€CSS æ ·å¼æ–‡ä»¶ã€æ¸…å•æ–‡ä»¶ç­‰
 */

import esbuild from 'esbuild'
import postcss from 'postcss'
import postcssNesting from 'postcss-nesting'
import builtins from 'builtin-modules'
import fs from 'fs-extra'
import path from 'path'
import { fileURLToPath } from 'url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)
const projectRoot = path.join(__dirname, '..')

const banner = `/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/
`

// å‘½ä»¤è¡Œå‚æ•°å¤„ç†
const args = process.argv.slice(2)
const isProduction = args.includes('--production') || args.includes('-p')
const keepConsole = args.includes('--keep-console')
const outputDir =
	args.find((arg) => arg.startsWith('--output='))?.split('=')[1] || 'dist'

console.log('ğŸš€ å¼€å§‹æ„å»º Obsidian ä½¿ç”¨ç»Ÿè®¡æ’ä»¶...')
console.log(`ğŸ“ è¾“å‡ºç›®å½•: ${outputDir}`)
console.log(`ğŸ—ï¸  æ„å»ºæ¨¡å¼: ${isProduction ? 'ç”Ÿäº§' : 'å¼€å‘'}`)

// åˆ›å»ºè¾“å‡ºç›®å½•
const distPath = path.join(projectRoot, outputDir)
await fs.ensureDir(distPath)

// æ¸…ç†è¾“å‡ºç›®å½•
console.log('ğŸ§¹ æ¸…ç†è¾“å‡ºç›®å½•...')
await fs.emptyDir(distPath)

// CSS å¤„ç†æ’ä»¶
const cssReBuild = () => ({
	name: 'css-rebuild',
	setup(build) {
		build.onLoad({ filter: /\.css$/ }, async (args) => {
			try {
				const css = await fs.promises.readFile(args.path, 'utf8')
				const result = await postcss([postcssNesting]).process(css, {
					from: args.path,
				})

				return {
					contents: result.css,
					loader: 'css',
				}
			} catch (error) {
				console.error('âŒ CSS å¤„ç†é”™è¯¯:', error)
				return {
					contents: '',
					loader: 'css',
				}
			}
		})
	},
})

// æ–‡ä»¶å¤åˆ¶æ’ä»¶
const copyFilesPlugin = () => ({
	name: 'copy-files',
	setup(build) {
		build.onEnd(async (result) => {
			if (result.errors.length > 0) {
				console.error('âŒ æ„å»ºå¤±è´¥ï¼Œè·³è¿‡æ–‡ä»¶å¤åˆ¶')
				return
			}

			console.log('ğŸ“‹ å¤åˆ¶å¿…è¦æ–‡ä»¶...')

			try {
				// å¤åˆ¶ manifest.json
				const manifestSrc = path.join(projectRoot, 'manifest.json')
				const manifestDest = path.join(distPath, 'manifest.json')
				await fs.copy(manifestSrc, manifestDest)
				console.log('âœ… å¤åˆ¶ manifest.json')

				// å¤åˆ¶ styles.cssï¼ˆå¦‚æœå­˜åœ¨ï¼‰
				const stylesSrc = path.join(projectRoot, 'styles.css')
				const stylesDest = path.join(distPath, 'styles.css')
				if (await fs.pathExists(stylesSrc)) {
					await fs.copy(stylesSrc, stylesDest)
					console.log('âœ… å¤åˆ¶ styles.css')
				}

				// å¤åˆ¶ç‹¬ç«‹çš„ CSS æ–‡ä»¶åˆ° dist
				const cssFiles = ['style/usage-stats.css', 'style/view-styles.css']

				for (const cssFile of cssFiles) {
					const srcPath = path.join(projectRoot, cssFile)
					if (await fs.pathExists(srcPath)) {
						const fileName = path.basename(cssFile)
						const destPath = path.join(distPath, fileName)
						await fs.copy(srcPath, destPath)
						console.log(`âœ… å¤åˆ¶ ${cssFile}`)
					}
				}

				// å¤åˆ¶ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
				const versionFiles = ['versions.json', 'CHANGELOG.md', 'README.md']
				for (const file of versionFiles) {
					const srcPath = path.join(projectRoot, file)
					if (await fs.pathExists(srcPath)) {
						const destPath = path.join(distPath, file)
						await fs.copy(srcPath, destPath)
						console.log(`âœ… å¤åˆ¶ ${file}`)
					}
				}

				// ç”Ÿæˆæ‰“åŒ…ä¿¡æ¯æ–‡ä»¶
				const buildInfo = {
					buildTime: new Date().toISOString(),
					version: JSON.parse(
						await fs.readFile(path.join(projectRoot, 'manifest.json'), 'utf8')
					).version,
					mode: isProduction ? 'production' : 'development',
					outputDir: outputDir,
				}

				await fs.writeJSON(path.join(distPath, 'build-info.json'), buildInfo, {
					spaces: 2,
				})
				console.log('âœ… ç”Ÿæˆæ„å»ºä¿¡æ¯æ–‡ä»¶')
			} catch (error) {
				console.error('âŒ æ–‡ä»¶å¤åˆ¶å¤±è´¥:', error)
			}
		})
	},
})

// CSS é‡å‘½åæ’ä»¶
const cssRenamePlugin = () => ({
	name: 'css-rename-plugin',
	setup(build) {
		build.onEnd(async (result) => {
			const outfile = build.initialOptions.outfile
			const outdir = path.dirname(outfile)
			const cssFile = path.join(outdir, 'main.css')
			const stylesFile = path.join(outdir, 'styles.css')

			if (await fs.pathExists(cssFile)) {
				try {
					if (await fs.pathExists(stylesFile)) {
						await fs.remove(stylesFile)
					}
					await fs.move(cssFile, stylesFile)
					console.log('âœ… CSS æ–‡ä»¶é‡å‘½åä¸º styles.css')
				} catch (e) {
					console.error('âŒ CSS æ–‡ä»¶é‡å‘½åå¤±è´¥:', e)
				}
			}
		})
	},
})

// esbuild é…ç½®
const buildConfig = {
	banner: {
		js: banner,
	},
	entryPoints: [path.join(projectRoot, 'src/main.ts')],
	bundle: true,
	plugins: [cssReBuild(), cssRenamePlugin(), copyFilesPlugin()],
	external: [
		'obsidian',
		'electron',
		'@codemirror/autocomplete',
		'@codemirror/collab',
		'@codemirror/commands',
		'@codemirror/language',
		'@codemirror/lint',
		'@codemirror/search',
		'@codemirror/state',
		'@codemirror/view',
		'@lezer/common',
		'@lezer/highlight',
		'@lezer/lr',
		...builtins,
	],
	format: 'cjs',
	target: 'es2020',
	logLevel: 'info',
	sourcemap: isProduction ? false : 'inline',
	treeShaking: true,
	outfile: path.join(distPath, 'main.js'),
	minify: isProduction,
	drop: isProduction && !keepConsole ? ['console', 'debugger'] : [],
	loader: {
		'.ttf': 'base64',
		'.woff': 'base64',
		'.woff2': 'base64',
		'.eot': 'base64',
		'.svg': 'text',
		'.png': 'base64',
		'.jpg': 'base64',
		'.jpeg': 'base64',
		'.gif': 'base64',
	},
	define: {
		'process.env.NODE_ENV': JSON.stringify(
			isProduction ? 'production' : 'development'
		),
	},
}

// æ‰§è¡Œæ„å»º
try {
	console.log('âš¡ å¼€å§‹ç¼–è¯‘ TypeScript å’Œæ‰“åŒ…èµ„æº...')

	const result = await esbuild.build(buildConfig)

	if (result.errors.length > 0) {
		console.error('âŒ æ„å»ºè¿‡ç¨‹ä¸­å‘ç°é”™è¯¯:')
		result.errors.forEach((error) => console.error(error))
		process.exit(1)
	}

	if (result.warnings.length > 0) {
		console.warn('âš ï¸  æ„å»ºè¿‡ç¨‹ä¸­å‘ç°è­¦å‘Š:')
		result.warnings.forEach((warning) => console.warn(warning))
	}

	// æ˜¾ç¤ºæ‰“åŒ…åçš„æ–‡ä»¶ä¿¡æ¯
	console.log('\nğŸ“¦ æ‰“åŒ…å®Œæˆï¼ç”Ÿæˆçš„æ–‡ä»¶:')
	console.log('='.repeat(50))

	const files = await fs.readdir(distPath)
	for (const file of files) {
		const filePath = path.join(distPath, file)
		const stats = await fs.stat(filePath)
		const size = (stats.size / 1024).toFixed(1)
		console.log(`ğŸ“„ ${file.padEnd(20)} ${size.padStart(8)} KB`)
	}

	console.log('='.repeat(50))
	console.log(`âœ¨ æ„å»ºæˆåŠŸï¼è¾“å‡ºç›®å½•: ${distPath}`)
	console.log(`ğŸ¯ æ’ä»¶å·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥å¤åˆ¶åˆ° Obsidian æ’ä»¶ç›®å½•ä¸­ä½¿ç”¨`)
} catch (error) {
	console.error('âŒ æ„å»ºå¤±è´¥:', error)
	process.exit(1)
}
