# OAuth 回调处理使用说明

## 功能概述

Obsidian Usage Stats 插件现在支持完整的 OAuth 2.0 (PKCE) 认证流程，可以自动处理来自 Obtime 服务的回调URL，并在后台完成用户认证和数据同步。

## 回调URL格式

插件现在可以自动处理以下格式的OAuth回调URL：

```
obsidian://oauth/callback?code=<authorization_code>&state=<state_parameter>
```

例如您提供的URL：
```
obsidian://oauth/callback?code=eb301450e46295bd530bb5095da08da7&state=djrx49ddivu5i4gsdp8jzi
```

## 自动处理流程

当用户点击授权链接并完成认证后，Obsidian会接收到回调URL，插件将自动执行以下步骤：

### 1. URL解析和验证
- 自动解析回调URL中的授权码(code)和状态参数(state)
- 验证参数完整性

### 2. 令牌交换
- 使用授权码换取访问令牌(access_token)
- 获取刷新令牌(refresh_token)以便后续自动刷新

### 3. 用户信息获取
- 使用访问令牌获取用户基本信息
- 包括：用户ID、邮箱、昵称等

### 4. 数据持久化保存
- 访问令牌和刷新令牌安全保存到Obsidian插件数据存储中
- 用户信息保存到插件设置中
- 所有敏感数据都通过Obsidian的数据存储机制加密保存

### 5. 自动同步(可选)
- 如果启用了云同步功能，会立即尝试同步当前使用数据
- 如果启用了自动同步，会开始定期同步计划

## 用户体验

- **无需手动操作**：整个过程在后台自动完成
- **即时反馈**：认证成功后会显示通知消息
- **状态更新**：插件设置页面会自动更新登录状态
- **多语言支持**：所有提示消息支持中英文

## 错误处理

插件包含完整的错误处理机制：

- **网络错误**：自动重试机制
- **令牌过期**：自动刷新访问令牌
- **认证失败**：清晰的错误提示和日志记录
- **数据同步失败**：不影响基本认证功能

## 数据安全

- 所有OAuth令牌都通过Obsidian的安全存储机制保存
- 访问令牌会自动刷新，避免过期问题
- 用户可以随时在设置中退出登录，清除所有认证数据

## 配置说明

在插件设置的"云同步"部分：

- **启用数据同步**：开启后将数据同步到云端
- **自动同步**：启用后会定期自动同步
- **同步间隔**：设置自动同步的频率(分钟)
- **手动同步**：支持手动触发即时同步

## 开发者信息

- 使用标准 OAuth 2.0 PKCE 流程
- 支持令牌自动刷新
- 兼容 Obsidian 的插件生命周期
- 完整的TypeScript类型定义
